api_route: /api/

clusters:
  # gRPC сервис (fake-service в gRPC режиме)
  - name: web
    addr: "web:9091"
    type: "grpc"

  # HTTP сервис (fake-service в HTTP режиме)
  - name: web-http
    addr: "web-http:9092"
    type: "http"
    health_check:
      path: "/health"
      interval_seconds: 10

  # Unhealthy cluster for testing (port not listening)
  - name: unhealthy-demo
    addr: "web-http:9999"
    type: "http"
    health_check:
      path: "/health"
      interval_seconds: 5

  # gRPC Health service (for streaming tests)
  - name: health-demo
    addr: "health-demo:8081"
    type: "grpc"

  # HTTP Echo service - returns all headers in JSON response
  # Use for testing auth-adapter header enrichment (user-id, session-id)
  - name: http-echo
    addr: "http-echo:8888"
    type: "http"

apis:
  # gRPC-Web тестирование
  - name: FakeService
    cluster: web
    auth: {policy: no-need}
    methods:
      - name: Handle
        auth:
          policy: no-need
          rate_limit: {period: "1m", count: 10, delay: "3s"}

  # HTTP REST тестирование (public)
  - name: HttpService
    cluster: web-http
    auth: {policy: no-need}
    methods:
      - name: health
        auth: {policy: no-need}
      - name: echo
        auth: {policy: no-need}

  # Protected HTTP endpoint (requires auth)
  - name: ProtectedService
    cluster: web-http
    auth: {policy: required}
    methods:
      - name: profile
        auth:
          policy: required
      - name: data
        auth:
          policy: optional

  # Unhealthy service for testing health checks
  - name: UnhealthyService
    cluster: unhealthy-demo
    auth: {policy: no-need}

  # gRPC Health service (streaming test via Watch method)
  - name: grpc.health.v1.Health
    cluster: health-demo
    auth: {policy: no-need}
    methods:
      - name: Check
        auth: {policy: no-need}

  # =========================================================================
  # HTTP Echo Service - Header Inspection Tests
  # Returns JSON with all received headers for debugging auth-adapter
  # =========================================================================

  # Public echo - no auth required (baseline test)
  - name: EchoPublic
    cluster: http-echo
    auth: {policy: no-need}
    methods:
      - name: headers
        auth: {policy: no-need}
      - name: test
        auth: {policy: no-need}

  # Protected echo - auth required (should show user-id, session-id headers)
  - name: EchoProtected
    cluster: http-echo
    auth: {policy: required}
    methods:
      - name: headers
        auth: {policy: required}
      - name: profile
        auth: {policy: required}

  # Optional auth echo - auth optional (shows headers if authenticated)
  - name: EchoOptional
    cluster: http-echo
    auth: {policy: optional}
    methods:
      - name: headers
        auth: {policy: optional}